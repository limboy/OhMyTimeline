<!--配置项开始-->
<script>
  const config = `
# 从哪一年开始展示
startYear: 1984

# 头像地址
avatar: https://limboy.me/logo.jpg

# 你的名字
name: Limboy

# 一个剪短的说明
bio: get busy living or get busy dying

timeline:
# 会展示在左边栏
- title: 教育

# 可选项位 line 或者 bar，前者是横线，后者是方块，通常用来展示数值，参考「收入」
  displayType: line

  items:
# 开始的时间点，格式为 年.月，结束时间同
  - startDate: '1991.9'
    endDate: '1997.7'
# 对当前这段时间的描述
    desc: 小学
  - startDate: '1997.9'
    endDate: '2000.7'
    desc: 中学
  - startDate: '2000.9'
    endDate: '2003.7'
    desc: 高中
  - startDate: '2003.9'
    endDate: '2007.7'
    desc: 大学（大连理工）

- title: 旅行
  displayType: line
  items:
  - startDate: '2014.11'
    endDate: '2014.11'
    desc: 清迈
  - startDate: '2015.6'
    endDate: '2015.6'
    desc: 台北
  - startDate: '2016.2'
    endDate: '2016.2'
    desc: 普吉岛
  - startDate: '2016.10'
    endDate: '2016.10'
    desc: 日本
  - startDate: '2018.6'
    endDate: '2018.6'
    desc: 日本
  - startDate: '2018.12'
    endDate: '2018.12'
    desc: 日本
  - startDate: '2016.12'
    endDate: '2016.12'
    desc: 香港
  - startDate: '2017.6'
    endDate: '2017.6'
    desc: 美国（WWDC）
  - startDate: '2020.1'
    endDate: '2020.1'
    desc: 日本

- title: 收入
  displayType: bar
  valueDesc: (Percent)
  items:
  - startDate: '2008.5'
    endDate: '2009.4'
    desc: 时光网
    value: 0.05
  - startDate: '2010.4'
    endDate: '2011.7'
    desc: 凤凰网
    value: 0.1
  - startDate: '2011.7'
    endDate: '2012.4'
    value: 0.15
    desc: 知乎
  - startDate: '2013.6'
    endDate: '2014.11'
    value: 0.25
    desc: 花瓣
  - startDate: '2014.11'
    endDate: '2018.6'
    value: 0.4
    desc: 蘑菇街
  - startDate: '2019.6'
    endDate: '2021.7'
    value: 1
    desc: 字节跳动

- title: 一些小事
  displayType: line
  items:
  - startDate: '2007.6'
    endDate: '2007.6'
    desc: 跑完马拉松全程，用时4个半小时，第 173 名（共 8500 人参赛）
  - startDate: '2007.5'
    endDate: '2007.5'
    desc: 第一条推
    url: https://twitter.com/lzyy/status/64679152?s=20
  - startDate: '2010.8'
    endDate: '2010.8'
    desc: 第一篇博客文章
    url: https://limboy.me/2010/08/25/make-github-as-blog-engine/
  - startDate: '2011.4'
    endDate: '2011.4'
    desc: 第一台苹果设备（Macbook Air）
  - startDate: '2014.7'
    endDate: '2014.7'
    desc: 作为讲师在 Arch Summit 大会（深圳）做分享
  - startDate: '2018.8'
    endDate: '2018.8'
    desc: 和老胡去香港看 Bob Dylan 演唱会
  - startDate: '2021.3'
    endDate: '2021.3'
    desc: 写了个贪吃蛇编程游戏，并在部门内部组织编程比赛
  - startDate: '2021.8'
    endDate: '2021.8'
    desc: 皇室战争 6500 杯

- title: 公司
  displayType: line
  items:
  - startDate: '2008.5'
    endDate: '2009.4'
    desc: 时光网（Flash开发)
  - startDate: '2010.4'
    endDate: '2011.7'
    desc: 凤凰网（PHP工程师）
  - startDate: '2011.7'
    endDate: '2012.4'
    desc: 知乎（后端 Python 工程师）
  - startDate: '2013.6'
    endDate: '2014.11'
    desc: 花瓣（iOS Dev）
  - startDate: '2014.11'
    endDate: '2018.6'
    desc: 蘑菇街（iOS Dev）
  - startDate: '2019.6'
    endDate: '2021.7'
    desc: 字节跳动（iOS Dev）

- title: 城市
  displayType: line
  items:
  - startDate: '1984.12'
    endDate: '2003.7'
    desc: 宁波
  - startDate: '2003.8'
    endDate: '2007.7'
    desc: 大连
  - startDate: '2007.8'
    endDate: '2007.10'
    desc: 佛山
  - startDate: '2007.11'
    endDate: '2008.4'
    desc: 大连
  - startDate: '2008.5'
    endDate: '2012.4'
    desc: 北京
  - startDate: '2012.5'
    endDate: '2021.9'
    desc: 杭州

- title: 影视剧
  displayType: line
  items:
  - startDate: '2021.4'
    endDate: '2021.4'
    desc: 钢琴家
  - startDate: '2021.4'
    endDate: '2021.4'
    desc: 芝加哥七君子
  - startDate: '2021.8'
    endDate: '2021.8'
    desc: 风筝
  - startDate: '2021.7'
    endDate: '2021.7'
    desc: 双层公寓：都会男女
  - startDate: '2021.8'
    endDate: '2021.8'
    desc: 虎牙狼人杀
  - startDate: '2021.8'
    endDate: '2021.8'
    desc: 大小谎言
  - startDate: '2021.8'
    endDate: '2021.8'
    desc: 短剧开始啦
  - startDate: '2021.8'
    endDate: '2021.8'
    desc: 盛夏未来
  - startDate: '2021.8'
    endDate: '2021.8'
    desc: 怒火·重案

- title: 阅读
  displayType: line
  items:
  - startDate: '2020.1'
    endDate: '2020.1'
    desc: 你当像鸟飞往你的山
  - startDate: '2021.3'
    endDate: '2021.3'
    desc: Why We Sleep
  - startDate: '2021.6'
    endDate: '2021.6'
    desc: 软件设计的哲学
  - startDate: '2021.6'
    endDate: '2021.6'
    desc: 创新者
  - startDate: '2021.6'
    endDate: '2021.6'
    desc: 夜晚的潜水艇
  - startDate: '2021.6'
    endDate: '2021.7'
    desc: How Computer Really Works
  - startDate: '2021.7'
    endDate: '2021.7'
    desc: How to Live
  - startDate: '2021.7'
    endDate: '2021.7'
    desc: 10 分钟冥想
  - startDate: '2021.7'
    endDate: '2021.7'
    desc: You don't know js
  - startDate: '2021.7'
    endDate: '2021.8'
    desc: 大脑的故事
  - startDate: '2021.8'
    endDate: '2021.8'
    desc: 社交天性
  - startDate: '2021.8'
    endDate: '2021.8'
    desc: 你的夏天还好吗
  - startDate: '2021.8'
    endDate: '2021.8'
    desc: 被讨厌的勇气
  - startDate: '2021.8'
    endDate: '2021.8'
    desc: 恶意
  - startDate: '2021.8'
    endDate: '2021.8'
    desc: 上帝掷骰子吗

  `;
</script>
<!--配置项结束-->

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>OhMyTimeline</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.7/dist/tailwind.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.2.4/dist/cdn.js"
    ></script>
    <script>
      const timelineData = jsyaml.load(config);
      const timelineDates = (() => {
        let dates = [];
        for (let i = timelineData.startYear; i <= 2022; i++) {
          let item = { year: i, months: [] };
          for (let j = 1; j <= 12; j++) {
            item.months.push(j);
          }
          dates.push(item);
        }
        return dates;
      })();

      const monthOfDates = (date1, date2) => {
        let date1Year, date1Month, date2Year, date2Month;
        [date1Year, date1Month] = date1.split('.');
        [date2Year, date2Month] = date2.split('.');
        return (
          (parseInt(date2Year) - parseInt(date1Year)) * 12 +
          (parseInt(date2Month) - parseInt(date1Month))
        );
      };

      const convertDateToIndex = (date) => {
        let year, month;
        [year, month] = date.split('.');
        let yearIndex = parseInt(year) - timelineData.startYear;
        return [yearIndex, month - 1];
      };

      const convertDateToPixels = (date) => {
        let yearIndex, monthIndex;
        [yearIndex, monthIndex] = convertDateToIndex(date);

        return (
          (12 * yearIndex + monthIndex) * Alpine.store('pixelsPerMonth').width
        );
      };

      const monthsBetweenDates = (date1, date2) => {
        let date1Year, date1Month, date2Year, date2Month;
        [date1Year, date1Month] = date1.split('.');
        [date2Year, date2Month] = date2.split('.');
        return (date2Year - date1Year) * 12 + (date2Month - date1Month);
      };

      const sectionHeight = (section) => {
        if (section.displayType == 'bar') {
          return Alpine.store('sectionHeight');
        }

        let nthFloor = floorOfItemIndex(section, section.items.length - 1)[0];

        let height = Alpine.store('sectionHeight');
        return (
          Alpine.store('sectionItemMargin') +
          (Alpine.store('sectionItemMargin') +
            Alpine.store('sectionItemHeight')) *
            (nthFloor + 1)
        );
      };

      const timelineHeight = () => {
        let height = 0;
        timelineData.timeline.forEach((section) => {
          height += sectionHeight(section);
        });
        return height;
      };

      // 返回两个值，第一个是总层数，方便计算 height，第二个是该 itemIndex 所在的层数，方便展示
      const floorOfItemIndex = (section, itemIndex) => {
        let items = [];
        let filled = [];
        let positionLevel = -1;

        for (let i = 0; i <= itemIndex; i++) {
          items.push(section.items[i]);
        }

        items.forEach((item, index) => {
          let foundPosition = false;
          let months = monthsBetweenDates(item.startDate, item.endDate);
          let startIndex = monthsBetweenDates(
            timelineData.startYear + '.1',
            item.startDate
          );

          for (let i = 0; i < filled.length; i++) {
            let positionTaken = false;
            for (let j = 0; j <= months; j++) {
              positionTaken = filled[i].find(
                (index) => index == startIndex + j
              );
              if (positionTaken) {
                break;
              }
            }

            if (!positionTaken) {
              foundPosition = true;
              for (let k = 0; k <= months; k++) {
                filled[i].push(startIndex + k);
              }

              // 如果是最后一个，说明找到了
              if (index == itemIndex) {
                positionLevel = i;
              }
              break;
            }
          }

          if (!foundPosition) {
            let positions = [];
            for (let i = 0; i <= months; i++) {
              positions.push(startIndex + i);
            }
            filled.push(positions);
          }
        });

        // 从第 0 层开始算起
        return [
          filled.length - 1,
          positionLevel == -1 ? filled.length - 1 : positionLevel,
        ];
      };

      const heightOfBarItemIndex = (section, itemIndex) => {
        let maxValue = Math.max(...section.items.map((item) => item.value));
        return Math.ceil(
          (section.items[itemIndex].value / maxValue) *
            Alpine.store('maxBarHeight')
        );
      };

      const widthOfBarItem = (item) => {
        let months = monthsBetweenDates(item.startDate, item.endDate) + 1;
        return months * Alpine.store('pixelsPerMonth').width;
      };

      const stretchBtnClick = (timelineArea) => {
        let normalWidth = 20;
        let stretchWidth = 80;
        let currentWidth = Alpine.store('pixelsPerMonth').width;
        Alpine.store('pixelsPerMonth').width =
          currentWidth == stretchWidth ? normalWidth : stretchWidth;
        if (currentWidth == normalWidth) {
          setTimeout(() => {
            timelineArea.scroll(
              timelineArea.scrollLeft * (stretchWidth / normalWidth),
              timelineArea.scrollTop
            );
          }, 0);
        } else {
          timelineArea.scroll(
            timelineArea.scrollLeft / (stretchWidth / normalWidth),
            timelineArea.scrollTop
          );
        }
      };

      document.addEventListener('alpine:init', () => {
        Alpine.store('timelineData', timelineData);
        Alpine.store('timelineDates', timelineDates);
        Alpine.store('monthOfDates', monthOfDates);
        Alpine.store('monthBarHeight', 24);
        Alpine.store('headerHeight', 186);
        Alpine.store('endYear', 2022);
        Alpine.store('sectionHeight', 33);
        Alpine.store('barColor', '#2564eb');
        Alpine.store('lineColor', '#2564eb');
        Alpine.store('timelineHeight', timelineHeight);
        Alpine.store('sectionTotalHeight', sectionHeight);
        Alpine.store('convertDateToPixels', convertDateToPixels);
        Alpine.store('monthsBetweenDates', monthsBetweenDates);
        Alpine.store('floorOfItemIndex', floorOfItemIndex);
        Alpine.store('heightOfBarItemIndex', heightOfBarItemIndex);
        Alpine.store('widthOfBarItem', widthOfBarItem);
        Alpine.store('stretchBtnClick', stretchBtnClick);
        Alpine.store('maxBarHeight', Alpine.store('sectionHeight') * 0.6);
        Alpine.store('sectionItemHeight', 0.6 * Alpine.store('sectionHeight'));
        Alpine.store(
          'sectionItemMargin',
          (Alpine.store('sectionHeight') - Alpine.store('sectionItemHeight')) /
            2
        );
        Alpine.store('pixelsPerMonth', Alpine.reactive({ width: 20 }));
      });

      document.addEventListener('alpine:initialized', () => {
        tippy('[data-tippy-content]');
      });
    </script>
  </head>

  <body x-data="$store.timelineData">
    <div
      class="fixed flex flex-col inset-0 items-center p-4 z-10"
      :style="`height:${$store.headerHeight}; background-color: rgb(51, 51, 51)`"
    >
      <div class="w-20 h-20">
        <img class="rounded-full" :src="$store.timelineData.avatar" />
      </div>
      <div class="text-2xl text-white" x-text="$store.timelineData.name"></div>
      <div class="text-gray-400" x-text="$store.timelineData.bio"></div>
      <div
        class="rounded-full text-gray-300 text-xs px-2 mt-1 cursor-pointer"
        @click="$store.stretchBtnClick($refs.timelinearea)"
        :style="`height:20px; line-height: 20px; background-color:rgb(0,0,0,0.6)`"
        x-text="$store.pixelsPerMonth.width == 20 ? '←→' : '→←'"
      ></div>
    </div>

    <div
      class="relative overflow-hidden"
      :style="`min-height: calc(100vh - ${$store.headerHeight}px); margin-top: ${$store.headerHeight}px`"
    >
      <div class="absolute w-48 bg-white border-r border-gray-600">
        <div
          class="border-b border-gray-600"
          :style="`height: ${$store.monthBarHeight}px`"
        ></div>
        <template x-for="section in timeline">
          <div
            class="border-b border-gray-600 pl-2 text-sm"
            x-text="section.title"
            :style="`height: ${$store.sectionTotalHeight(section)}px; line-height: ${$store.sectionHeight}px`"
          ></div>
        </template>
      </div>
      <div
        class="relative h-full"
        :style="`height: ${$store.timelineHeight() + $store.monthBarHeight}px`"
      >
        <div
          class="ml-48 h-full overflow-y-scroll relative"
          x-ref="timelinearea"
        >
          <template x-for="(item, index) in $store.timelineDates">
            <div
              class="h-full bg-gray-600 absolute"
              :style="`width:${index == 0 ? 0 : 1}px; left: ${$store.pixelsPerMonth.width*12*index}px`"
            ></div>
          </template>
          <div
            class="h-full text-sm"
            :style="`width: ${($store.endYear - $store.timelineData.startYear + 1)*12*$store.pixelsPerMonth.width}px;z-index:-1; background-image:radial-gradient(1px 1px at center, #ccc, transparent 1px);background-position:-${$store.pixelsPerMonth.width/2}px 0;background-size:${$store.pixelsPerMonth.width}px 6px`"
          >
            <div
              class="flex border-b border-gray-600 bg-white"
              :style="`height: ${$store.monthBarHeight}px;`"
            >
              <template x-for="item in $store.timelineDates">
                <div>
                  <div
                    class="text-center h-full"
                    x-text="item.year"
                    :style="`height:${$store.monthBarHeight}px; line-height:${$store.monthBarHeight}px; width:${$store.pixelsPerMonth.width*12}px;`"
                  ></div>
                </div>
              </template>
            </div>

            <template x-for="section in timeline">
              <div
                class="border-b relative border-gray-600 flex items-center"
                :style="`height: ${$store.sectionTotalHeight(section)}px; line-height: ${$store.sectionHeight}px`"
              >
                <template x-if="section.displayType == 'line'">
                  <template x-for="(item, index) in section.items">
                    <div
                      class="
                        absolute
                        overflow-hidden
                        rounded-full
                        text-xs text-white
                      "
                      x-html="item.url ? `<a target='_blank' class='underline' href='${item.url}'>${item.desc}</a>` : item.desc"
                      :data-tippy-content="item.desc ? item.desc : section.title"
                      :style="`background-color:${$store.lineColor};top:${$store.sectionItemMargin + $store.floorOfItemIndex(section, index)[1] * ($store.sectionItemMargin + $store.sectionItemHeight)}px; padding-left:6px;height:${$store.sectionItemHeight}px; line-height: ${$store.sectionItemHeight}px; left: ${$store.convertDateToPixels(item.startDate)}px; width:${($store.monthsBetweenDates(item.startDate, item.endDate)+1)*$store.pixelsPerMonth.width}px;`"
                    ></div>
                  </template>
                </template>
                <template x-if="section.displayType == 'bar'">
                  <template x-for="(item, index) in section.items">
                    <div
                      class="h-full absolute flex flex-col-reverse"
                      :style="`left: ${$store.convertDateToPixels(item.startDate)}px; width:${$store.widthOfBarItem(item)}px;`"
                      :data-tippy-content="item.value + `${section.valueDesc ? section.valueDesc : ''}` + `${item.desc ? ' ('+item.desc+')' : ''}`"
                    >
                      <div
                        class=""
                        :style="`background-color:${$store.barColor};top:${$store.sectionHeight - $store.heightOfBarItemIndex(section, index)}px; height:${$store.heightOfBarItemIndex(section, index)}px;`"
                      ></div>
                    </div>
                  </template>
                </template>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- 请保留这个小东东，谢谢 -->
      <div class="mt-2 opacity-10 flex flex-col items-center">
        <a href="https://limboy.me" target="_blank">👻</a>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tippy.js@6.3.1/dist/tippy-bundle.umd.min.js"></script>
  </body>
</html>
